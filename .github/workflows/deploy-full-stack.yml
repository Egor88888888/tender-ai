name: Deploy Full Azure Stack

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_infrastructure:
        description: "Deploy new infrastructure"
        required: false
        default: false
        type: boolean

jobs:
  build-and-deploy-api:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get ACR Info
        id: acr-info
        run: |
          ACR_NAME=$(az acr list --resource-group tender-rg --query "[0].name" -o tsv)
          ACR_LOGIN_SERVER=$(az acr show --name $ACR_NAME --resource-group tender-rg --query "loginServer" -o tsv)
          echo "acr_name=$ACR_NAME" >> $GITHUB_OUTPUT
          echo "acr_login_server=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT

      - name: Get ACR Credentials
        id: acr-creds
        run: |
          ACR_USERNAME=$(az acr credential show --name ${{ steps.acr-info.outputs.acr_name }} --query "username" -o tsv)
          ACR_PASSWORD=$(az acr credential show --name ${{ steps.acr-info.outputs.acr_name }} --query "passwords[0].value" -o tsv)
          echo "acr_username=$ACR_USERNAME" >> $GITHUB_OUTPUT
          echo "acr_password=$ACR_PASSWORD" >> $GITHUB_OUTPUT

      - name: Docker Login to ACR
        run: |
          echo "${{ steps.acr-creds.outputs.acr_password }}" | docker login ${{ steps.acr-info.outputs.acr_login_server }} -u ${{ steps.acr-creds.outputs.acr_username }} --password-stdin

      - name: Build and Push Docker Image
        run: |
          cd backend
          docker build -t ${{ steps.acr-info.outputs.acr_login_server }}/tender-api:${{ github.sha }} .
          docker build -t ${{ steps.acr-info.outputs.acr_login_server }}/tender-api:latest .
          docker push ${{ steps.acr-info.outputs.acr_login_server }}/tender-api:${{ github.sha }}
          docker push ${{ steps.acr-info.outputs.acr_login_server }}/tender-api:latest

      - name: Update Container App
        run: |
          az containerapp update \
            --name tender-api \
            --resource-group tender-rg \
            --image ${{ steps.acr-info.outputs.acr_login_server }}/tender-api:${{ github.sha }}

  test-deployment:
    runs-on: ubuntu-latest
    needs: [build-and-deploy-api]

    steps:
      - name: Test API Health
        run: |
          API_URL="https://tender-api.bravesmoke-248b9fb5.westeurope.azurecontainerapps.io"

          echo "Testing API health..."
          for i in {1..10}; do
            if curl -f -s "$API_URL/health"; then
              echo "âœ… API is healthy"
              break
            else
              echo "â³ Waiting for API... (attempt $i/10)"
              sleep 30
            fi
          done

          echo "Testing full API status..."
          curl -s "$API_URL/"

      - name: Summary
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ“Š API URL: https://tender-api.bravesmoke-248b9fb5.westeurope.azurecontainerapps.io"
          echo "ğŸ“š API Docs: https://tender-api.bravesmoke-248b9fb5.westeurope.azurecontainerapps.io/docs"
